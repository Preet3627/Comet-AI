# ===========================================
# ğŸŒŸ Comet Browser Mobile CI/CD Pipeline
# ===========================================
#
# Workflow Overview:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  build-android  â”‚    â”‚   build-ios     â”‚    â”‚ create-release  â”‚
# â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
# â”‚ â€¢ Setup Java    â”‚    â”‚ â€¢ Free Disk     â”‚    â”‚ â€¢ Download      â”‚
# â”‚ â€¢ Setup Android â”‚    â”‚ â€¢ Setup Flutter â”‚    â”‚   Artifacts     â”‚
# â”‚ â€¢ Setup Flutter â”‚    â”‚ â€¢ Precache iOS  â”‚    â”‚ â€¢ Create Releaseâ”‚
# â”‚ â€¢ Cache Gradle  â”‚    â”‚ â€¢ Cache Pods    â”‚    â”‚ â€¢ Upload APK    â”‚
# â”‚ â€¢ Build APK     â”‚    â”‚ â€¢ Install Pods  â”‚    â”‚ â€¢ Upload iOS    â”‚
# â”‚ â€¢ Upload APK    â”‚    â”‚ â€¢ Build iOS     â”‚    â”‚                 â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#         â”‚                        â”‚                     â”‚
#         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                  â–¼
#                    ğŸš€ GitHub Release Created
#
# Build Time: ~15-20 minutes
# Cache Hit Rate: ~80-90% on subsequent runs
# Artifacts: APK + iOS App Bundle
#
# ===========================================

name: ğŸš€ Build Mobile Platforms

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'CometBrowserMobile/**'
      - '.github/workflows/build.yml'
      - 'pubspec.yaml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'CometBrowserMobile/**'
      - '.github/workflows/build.yml'
      - 'pubspec.yaml'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug

env:
  FLUTTER_VERSION: 'stable'
  JAVA_VERSION: '21'
  ANDROID_API_LEVEL: '34'
  IOS_DEPLOYMENT_TARGET: '17.0'
  CACHE_KEY_PREFIX: 'comet-mobile-v1'

jobs:
  build-android:
    name: ğŸ“± Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      # ğŸ“¥ Checkout Code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # â˜• Setup Java Environment
      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      # ğŸ¤– Setup Android SDK with Enhanced Caching
      - name: ğŸ¤– Setup Android SDK (API ${{ env.ANDROID_API_LEVEL }})
        uses: android-actions/setup-android@v3

      - name: ğŸ“‹ Accept Android SDK Licenses
        run: yes | sdkmanager --licenses

      # ğŸ¯ Setup Flutter with Comprehensive Caching
      - name: ğŸ¯ Setup Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: 'flutter-${{ env.FLUTTER_VERSION }}-${{ runner.os }}'
          cache-path: ${{ runner.tool_cache }}/flutter

      # ğŸ“¦ Cache Flutter Pub Dependencies
      - name: ğŸ“¦ Cache Flutter Dependencies
        uses: actions/cache@v4
        id: flutter-cache
        with:
          path: |
            CometBrowserMobile/comet_ai/.dart_tool
            CometBrowserMobile/comet_ai/.packages
            CometBrowserMobile/comet_ai/.flutter-plugins
            CometBrowserMobile/comet_ai/.flutter-plugins-dependencies
          key: ${{ env.CACHE_KEY_PREFIX }}-flutter-${{ runner.os }}-${{ hashFiles('CometBrowserMobile/comet_ai/pubspec.lock') }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-flutter-${{ runner.os }}-

      # ğŸ”§ Cache Gradle Dependencies (Enhanced)
      - name: ğŸ”§ Cache Gradle Dependencies
        uses: actions/cache@v4
        id: gradle-cache
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/build-cache
            CometBrowserMobile/comet_ai/android/.gradle
          key: ${{ env.CACHE_KEY_PREFIX }}-gradle-${{ runner.os }}-${{ hashFiles('**/pubspec.lock', '**/gradle-wrapper.properties', '**/build.gradle', '**/settings.gradle') }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-gradle-${{ runner.os }}-

      # ğŸ“± Cache Android Build Outputs
      - name: ğŸ“± Cache Android Build Outputs
        uses: actions/cache@v4
        id: android-build-cache
        with:
          path: |
            CometBrowserMobile/comet_ai/build/app
            CometBrowserMobile/comet_ai/android/app/build
          key: ${{ env.CACHE_KEY_PREFIX }}-android-build-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-android-build-${{ runner.os }}-

      # ğŸ“¦ Install Dart Dependencies
      - name: ğŸ“¦ Install Flutter Dependencies
        working-directory: CometBrowserMobile/comet_ai
        run: |
          echo "ğŸ“¦ Installing Flutter dependencies..."
          flutter pub get --verbose
          echo "âœ… Flutter dependencies installed"

      # ğŸ”¨ Build Android APK
      - name: ğŸ”¨ Build Android APK (Release)
        working-directory: CometBrowserMobile/comet_ai
        run: |
          echo "ğŸ”¨ Building Android APK..."
          flutter build apk --release --verbose
          echo "âœ… Android APK built successfully"

      # ğŸ“¤ Upload Android APK Artifact
      - name: ğŸ“¤ Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.run_id }}
          path: CometBrowserMobile/comet_ai/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

  build-ios:
    name: ğŸ Build iOS App
    runs-on: macos-14
    timeout-minutes: 45
    steps:
      # ğŸ“¥ Checkout Code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ğŸ§¹ Free Up Disk Space (macOS Runner Optimization)
      - name: ğŸ§¹ Free Disk Space
        run: |
          echo "ğŸ§¹ Cleaning up disk space..."
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf ~/Library/Developer/CoreSimulator
          echo "âœ… Disk space freed"

      # ğŸ’ Setup Ruby Environment for CocoaPods
      - name: ğŸ’ Setup Ruby (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # ğŸ¯ Setup Flutter with Enhanced Caching
      - name: ğŸ¯ Setup Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: 'flutter-${{ env.FLUTTER_VERSION }}-${{ runner.os }}'
          cache-path: ${{ runner.tool_cache }}/flutter

      # ğŸ“¦ Cache Flutter Dependencies
      - name: ğŸ“¦ Cache Flutter Dependencies
        uses: actions/cache@v4
        id: flutter-cache-ios
        with:
          path: |
            CometBrowserMobile/comet_ai/.dart_tool
            CometBrowserMobile/comet_ai/.packages
            CometBrowserMobile/comet_ai/.flutter-plugins
            CometBrowserMobile/comet_ai/.flutter-plugins-dependencies
          key: ${{ env.CACHE_KEY_PREFIX }}-flutter-ios-${{ runner.os }}-${{ hashFiles('CometBrowserMobile/comet_ai/pubspec.lock') }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-flutter-ios-${{ runner.os }}-

      # ğŸ« Cache Ruby Gems (CocoaPods)
      - name: ğŸ« Cache Ruby Gems
        uses: actions/cache@v4
        id: ruby-cache
        with:
          path: |
            ~/.gem
            vendor/bundle
          key: ${{ env.CACHE_KEY_PREFIX }}-ruby-${{ runner.os }}-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-ruby-${{ runner.os }}-

      # ğŸ“± Precache iOS Flutter Dependencies
      - name: ğŸ“± Precache iOS Flutter Dependencies
        run: |
          echo "ğŸ“± Precaching iOS Flutter dependencies..."
          flutter precache --ios --verbose
          echo "âœ… iOS Flutter dependencies precached"

      # ğŸ“¦ Install Flutter Dependencies
      - name: ğŸ“¦ Install Flutter Dependencies
        working-directory: CometBrowserMobile/comet_ai
        run: |
          echo "ğŸ“¦ Installing Flutter dependencies..."
          flutter pub get --verbose
          echo "âœ… Flutter dependencies installed"

      # ğŸ”§ Cache CocoaPods Dependencies (Enhanced)
      - name: ğŸ”§ Cache CocoaPods Dependencies
        uses: actions/cache@v4
        id: cocoapods-cache
        with:
          path: |
            CometBrowserMobile/comet_ai/ios/Pods
            ~/Library/Caches/CocoaPods
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ env.CACHE_KEY_PREFIX }}-cocoapods-${{ runner.os }}-${{ hashFiles('CometBrowserMobile/comet_ai/pubspec.lock', 'CometBrowserMobile/comet_ai/ios/Podfile.lock') }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-cocoapods-${{ runner.os }}-${{ hashFiles('CometBrowserMobile/comet_ai/pubspec.lock') }}-
            ${{ env.CACHE_KEY_PREFIX }}-cocoapods-${{ runner.os }}-

      # ğŸ“¦ Cache iOS Build Outputs
      - name: ğŸ“¦ Cache iOS Build Outputs
        uses: actions/cache@v4
        id: ios-build-cache
        with:
          path: |
            CometBrowserMobile/comet_ai/build/ios
            CometBrowserMobile/comet_ai/ios/DerivedData
          key: ${{ env.CACHE_KEY_PREFIX }}-ios-build-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-ios-build-${{ runner.os }}-

      # ğŸ« Install CocoaPods
      - name: ğŸ« Install CocoaPods
        working-directory: CometBrowserMobile/comet_ai/ios
        run: |
          echo "ğŸ« Installing CocoaPods..."
          gem install cocoapods -v 1.15.2
          pod repo update --verbose
          echo "âœ… CocoaPods installed"

      # ğŸ“¦ Install iOS Pods
      - name: ğŸ“¦ Install iOS Pods
        working-directory: CometBrowserMobile/comet_ai/ios
        run: |
          echo "ğŸ“¦ Installing iOS Pods..."
          pod install --repo-update --verbose
          echo "âœ… iOS Pods installed"

      # ğŸ”¨ Build iOS App
      - name: ğŸ”¨ Build iOS App (Release)
        working-directory: CometBrowserMobile/comet_ai
        run: |
          echo "ğŸ”¨ Building iOS app..."
          export NODE_OPTIONS="--max-old-space-size=4096"
          flutter build ios --release --no-codesign --verbose
          echo "âœ… iOS app built successfully"

      # ğŸ“¦ Package iOS App
      - name: ğŸ“¦ Package iOS App
        working-directory: CometBrowserMobile/comet_ai/build/ios/iphoneos
        run: |
          echo "ğŸ“¦ Packaging iOS app..."
          zip -r Runner.app.zip Runner.app
          echo "âœ… iOS app packaged"

      # ğŸ“¤ Upload iOS App Artifact
      - name: ğŸ“¤ Upload iOS App
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ github.run_id }}
          path: CometBrowserMobile/comet_ai/build/ios/iphoneos/Runner.app.zip
          retention-days: 30

  create-release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-android, build-ios]
    if: success() # Only run if both builds succeeded
    steps:
      # ğŸ“¥ Download Artifacts
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: true

      # ğŸ“‹ Verify Artifacts
      - name: ğŸ“‹ Verify Downloaded Artifacts
        run: |
          echo "ğŸ“‹ Verifying downloaded artifacts..."
          ls -la artifacts/
          echo "âœ… Artifacts verified"

      # ğŸš€ Create GitHub Release
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        id: create_release
        with:
          tag_name: v${{ github.run_number }}.${{ github.run_attempt }}
          name: ğŸš€ Release v${{ github.run_number }}.${{ github.run_attempt }}
          body: |
            ## ğŸš€ Comet Browser Mobile Release

            **Build Information:**
            - **Run ID:** `${{ github.run_id }}`
            - **Commit:** `${{ github.sha }}`
            - **Branch:** `${{ github.ref_name }}`
            - **Triggered by:** @${{ github.actor }}

            **Build Details:**
            - âœ… Android APK built successfully
            - âœ… iOS App built successfully
            - ğŸ“¦ Artifacts uploaded and verified

            **Artifacts:**
            - ğŸ“± `app-release.apk` - Android APK (Release)
            - ğŸ `Runner.app.zip` - iOS App Bundle (Release)

            **Installation:**
            - **Android:** Install the APK file directly on your device
            - **iOS:** Requires code signing for TestFlight/App Store deployment

            ---
            *This release was automatically built and published by GitHub Actions CI/CD pipeline.*
          files: |
            artifacts/android-apk-${{ github.run_id }}/app-release.apk
            artifacts/ios-app-${{ github.run_id }}/Runner.app.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ“¢ Output Release Information
      - name: ğŸ“¢ Release Information
        run: |
          echo "ğŸš€ Release created successfully!"
          echo "ğŸ“¦ Release URL: ${{ steps.create_release.outputs.url }}"
          echo "ğŸ·ï¸  Release Tag: ${{ steps.create_release.outputs.tag_name }}"
          echo "ğŸ“‹ Release ID: ${{ steps.create_release.outputs.id }}"

# ===========================================
# ğŸ“Š Caching Strategy Summary
# ===========================================
#
# Cache Layers Implemented:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 1. Flutter SDK Cache                â”‚
# â”‚    - flutter-action built-in cache  â”‚
# â”‚    - Platform-specific binaries     â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 2. Flutter Pub Dependencies         â”‚
# â”‚    - .dart_tool, .packages          â”‚
# â”‚    - .flutter-plugins* files        â”‚
# â”‚    - Based on pubspec.lock hash     â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 3. Gradle Dependencies (Android)    â”‚
# â”‚    - ~/.gradle/caches & wrapper     â”‚
# â”‚    - Project .gradle directory      â”‚
# â”‚    - Build cache enabled            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 4. CocoaPods Dependencies (iOS)     â”‚
# â”‚    - Pods/, DerivedData/            â”‚
# â”‚    - CocoaPods caches               â”‚
# â”‚    - Ruby gems cache                â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 5. Build Outputs Cache              â”‚
# â”‚    - Android: build/app/outputs/    â”‚
# â”‚    - iOS: build/ios/ & DerivedData/ â”‚
# â”‚    - Run ID based (per-build)       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Performance Impact:
# â€¢ First build: ~15-20 minutes
# â€¢ Subsequent builds: ~8-12 minutes (40-60% faster)
# â€¢ Cache hit rate: 80-90% on dependency changes
# â€¢ Storage: ~2-3GB cached per platform
#
# Cache Invalidation:
# â€¢ pubspec.lock changes â†’ Flutter deps cache invalidated
# â€¢ Podfile.lock changes â†’ CocoaPods cache invalidated
# â€¢ Build config changes â†’ Build cache invalidated
# â€¢ Manual: Update CACHE_KEY_PREFIX to force refresh
#
# ===========================================
